<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mathematical Model - VFF-Nav</title>
    <link rel="stylesheet" href="styles/main.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-container">
                <a href="index.html" class="logo">VFF-Nav</a>
                <button class="nav-toggle">☰</button>
                <ul class="nav-menu">
                    <li><a href="index.html" class="nav-link">Home</a></li>
                    <li><a href="overview.html" class="nav-link">Overview</a></li>
                    <li><a href="quickstart.html" class="nav-link">Quick Start</a></li>
                    <li><a href="model.html" class="nav-link active">Model</a></li>
                    <li><a href="results.html" class="nav-link">Results</a></li>
                    <li><a href="team.html" class="nav-link">Team</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <header>
        <div class="container">
            <h1>Mathematical Model</h1>
            <p class="subtitle">Center of Mass Guidance Model - Electrostatic Analogy</p>
        </div>
    </header>

    <main class="container">
        <section>
            <h2>Model Overview</h2>
            <p>This model uses an analogy to electrostatic forces to guide a drone towards a goal while avoiding
                obstacles. The drone is treated as a charged particle influenced by attractive and repulsive forces.</p>
        </section>

        <section>
            <h2>Definitions</h2>
            <ul>
                <li>\(d\vec{p}\): Position vector of the drone</li>
                <li>\(d\vec{v} = \dfrac{d\vec{p}}{dt}\): Velocity vector of the drone</li>
                <li>\(\vec{g}\): Position vector of the goal</li>
                <li>\(\vec{o_i}\): Position vector of the center of obstacle \(i\) (assumed spherical)</li>
                <li>\(n_{obs}\): Number of obstacles</li>
                <li>\(\vec{r}_g = \vec{p} - \vec{g}\) (goal to drone)</li>
                <li>\(\vec{r}_i = \vec{p} - \vec{o_i}\) (obstacle to drone)</li>
                <li>\(\forall \vec{v} \neq \vec{0}, \hat{v} = \dfrac{\vec{v}}{\lVert\vec{v}\rVert}\). \(\hat{0} =
                    \vec{0}\). \(\hat{v}\) is dimensionless, even if \(\vec{v}\) has units.</li>
            </ul>
        </section>

        <section>
            <h2>Force Equations</h2>

            <h3>Total Force</h3>
            <div class="math-block">
                \[
                \vec{F}_{total} = \vec{F}_{goal} + \vec{F}_{\text{obs, squash}} + \vec{F}_{damping}
                \]
            </div>

            <h3>Goal Force</h3>
            <div class="math-block">
                \[
                \vec{F}_{goal} = \left( -F_{\text{goal, const}} + \frac{k_e \cdot Q_{drone} \cdot
                Q_{\text{goal}}}{\lVert\vec{r}_g\rVert^2 + \varepsilon_{\text{goal}}^2} \right) \hat{r}_g
                \]
            </div>

            <p><strong>Notes:</strong></p>
            <ul>
                <li>The goal force is always attractive, pulling the drone towards the goal, due to \(Q_{goal} <
                        0\).</li>
                <li>\(k_e = 1 \left(N \cdot m^2 \cdot C^{-2}\right)\), a Coulomb's constant analog, is included for
                    dimensional consistency.</li>
                <li>\(Q_{drone} = 1 \left(C\right)\) is the drone's charge, which is constant.</li>
            </ul>

            <h3>Obstacle Force</h3>
            <div class="math-block">
                \[
                \vec{F}_{\text{obs},i} = \left( \frac{ k_e \cdot Q_{drone} \cdot Q_i }{ \lVert\vec{r}_i\rVert^2 +
                \varepsilon_{\text{obs}}^2 } \right) \hat{r}_i
                \]
            </div>

            <h4>Raw and Squashed Obstacle Force</h4>
            <div class="math-block">
                \[
                \vec{F}_{\text{obs, raw}} = \sum_{i=1}^{n_{\text{obs}}}{\vec{F}_{\text{obs},i}}
                \]
                \[
                \vec{F}_{\text{obs, squash}} = F_{\text{fac,squash}} \cdot \tanh\left( \frac{ \lVert \vec{F}_{\text{obs,
                raw}} \rVert }{ F_{\text{sat}} } \right) \cdot \hat{F}_{\text{obs, raw}}
                \]
            </div>

            <h3>Damping Force</h3>
            <div class="math-block">
                \[
                \vec{F}_{damping} = -K_{damping} \cdot \vec{v}
                \]
            </div>

            <h3>From Guidance Field to Desired Velocity</h3>
            <p>Let \(\vec{F}_{\text{field}}\) define the direction in which the drone "should" move:</p>

            <p><strong>Compute the unit direction:</strong></p>
            <div class="math-block">
                \[
                \hat{d} = \begin{cases}
                \dfrac{\vec{F}_{\text{field}}}{\Vert \vec{F}_{\text{field}} \Vert}, & \text{if } \vec{F}_{\text{field}}
                \neq \vec{0} \\
                \vec{0}, & \text{otherwise}
                \end{cases}
                \]
            </div>

            <p>Fix a target scalar speed \(v_{\text{ideal}} > 0\) (constant in the code) and a slow-down distance
                \(d_{\text{slow}} = 4 \, \text{m}\).</p>

            <p><strong>Define the desired velocity vector:</strong></p>
            <div class="math-block">
                \[
                \vec{v}_{\text{set}} = v_{\text{ideal}} \cdot \max\left(\frac{1}{3},
                \frac{\lVert\vec{r}_g\rVert}{d_{\text{slow}}}\right) \cdot \hat{d}
                \]
            </div>

            <p>This scales down the velocity as the drone approaches the goal, ensuring smooth arrival.</p>

            <h3>Control System</h3>
            <p>After computing \(\vec{v}_{\text{set}}\), the control system is designed to resemble the PX4 control
                architecture to allow for meaningful calibration results. The system follows this cascade structure:</p>

            <ol>
                <li><strong>Velocity PID Controller</strong> - Computes desired acceleration setpoint from velocity
                    signal</li>
                <li><strong>Thrust Vector Computation</strong> - Converts acceleration to thrust force (world frame)
                </li>
                <li><strong>Thrust Command Extraction</strong> - Projects thrust along body z-axis and normalizes</li>
                <li><strong>Desired Attitude Computation</strong> - Derives quaternion from thrust vector and velocity
                    direction</li>
                <li><strong>Attitude Error to Body-Rate Setpoint</strong> - P-controller on attitude error quaternion
                </li>
                <li><strong>Body-Rate Clamping</strong> - Saturates angular velocity setpoints to maximum limits</li>
                <li><strong>Noise-Filtered Angular Velocity Derivative</strong> - 2nd-order Butterworth low-pass filter
                    on derivative of angular velocity measurement
                </li>
                <li><strong>Torque PID Controller</strong> - Computes body torque commands from body rate signal</li>
                <li><strong>Yaw Torque Filtering</strong> - 1st-order low-pass on yaw torque output</li>
                <li><strong>Force and Torque Application</strong> - Converts normalized commands to Newton
                    forces/torques in simulation</li>
            </ol>
        </section>

        <section>
            <h2>System Invariants</h2>

            <h3>VFF Guidance Constants</h3>
            <ul>
                <li>Coulomb's constant (analog): \(k_e = 1 \, \text{N} \cdot \text{m}^2 \cdot \text{C}^{-2}\)</li>
                <li>Drone charge: \(Q_{drone} = 1 \, \text{C}\)</li>
                <li>Obstacle charges: \(Q_i \in [0, +1] \, \text{C}\)</li>
                <li>Ideal velocity: \(v_{\text{ideal}} = 5.0 \, \text{m/s}\)</li>
                <li>Slow-down distance: \(d_{\text{slow}} = 4.0 \, \text{m}\)</li>
            </ul>

            <h3>Physical Properties</h3>
            <ul>
                <li>Drone mass: \(m = 2.064 \, \text{kg}\)</li>
                <li>Drone inertia: \(I_x = 0.034 \, \text{kg} \cdot \text{m}^2, \, I_y = 0.035 \, \text{kg} \cdot
                    \text{m}^2, \, I_z = 0.062 \, \text{kg} \cdot \text{m}^2\)</li>
                <li>Drone shape (box): \(0.6 \times 0.6 \times 0.27 \, \text{m}\)</li>
                <li>Gravity: \(g = 9.81 \, \text{m/s}^2\)</li>
            </ul>

            <h3>Actuator Limits</h3>
            <ul>
                <li>Maximum thrust: \(T_{\max} = 24.0 \, \text{N}\)</li>
                <li>Roll arm length: \(L_{\text{roll}} = 0.087 \, \text{m}\)</li>
                <li>Pitch arm length: \(L_{\text{pitch}} = 0.087 \, \text{m}\)</li>
                <li>Maximum yaw moment: \(Q_{\max} = 0.192 \, \text{N} \cdot \text{m}\)</li>
            </ul>

            <h3>Control System Fixed Parameters</h3>
            <ul>
                <li>Simulation timestep: \(\Delta t = 1/60 \, \text{s} \approx 0.0167 \, \text{s}\)</li>
                <li>Yaw torque filter cutoff: \(f_{c,\text{yaw}} = 2.0 \, \text{Hz}\)</li>
                <li>IMU gyro filter cutoff: \(f_{c,\text{gyro}} = 20.0 \, \text{Hz}\)</li>
                <li>Max roll rate: \(\omega_{\max,\phi} = 220.0 \, \text{rad/s}\)</li>
                <li>Max pitch rate: \(\omega_{\max,\theta} = 220.0 \, \text{rad/s}\)</li>
                <li>Max yaw rate: \(\omega_{\max,\psi} = 200.0 \, \text{rad/s}\)</li>
                <li>Roll rate integrator limit: \(I_{\max,\phi} = 0.3\)</li>
                <li>Pitch rate integrator limit: \(I_{\max,\theta} = 0.3\)</li>
                <li>Yaw rate integrator limit: \(I_{\max,\psi} = 0.3\)</li>
            </ul>
        </section>

        <section>
            <h2>Parameters for Calibration</h2>
            <p>These parameters are determined by the simulation calibration program.</p>

            <h3>VFF Guidance Parameters</h3>
            <table>
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>\(Q_{goal}\)</td>
                        <td>Goal charge</td>
                    </tr>
                    <tr>
                        <td>\(F_{goal, const}\)</td>
                        <td>Goal constant attraction</td>
                    </tr>
                    <tr>
                        <td>\(F_{\text{sat}}\)</td>
                        <td>Obstacle total saturation scale</td>
                    </tr>
                    <tr>
                        <td>\(F_{\text{fac,squash}}\)</td>
                        <td>Obstacle total factor after squashing</td>
                    </tr>
                    <tr>
                        <td>\(Q_{\text{vertical,obs}}\)</td>
                        <td>Vertical obstacle charge modifier</td>
                    </tr>
                </tbody>
            </table>

            <h3>Velocity PID Parameters</h3>
            <table>
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>\(K_x, K_y, K_z\)</td>
                        <td>Velocity P gains (x, y, z axes)</td>
                    </tr>
                    <tr>
                        <td>\(K_{i,x}, K_{i,y}, K_{i,z}\)</td>
                        <td>Velocity I gains (x, y, z axes)</td>
                    </tr>
                    <tr>
                        <td>\(K_{d,x}, K_{d,y}, K_{d,z}\)</td>
                        <td>Velocity D gains (x, y, z axes)</td>
                    </tr>
                </tbody>
            </table>

            <h3>Attitude Controller Parameters</h3>
            <table>
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>MC_ROLL_P</td>
                        <td>Roll attitude gain</td>
                    </tr>
                    <tr>
                        <td>MC_PITCH_P</td>
                        <td>Pitch attitude gain</td>
                    </tr>
                    <tr>
                        <td>MC_YAW_P</td>
                        <td>Yaw attitude gain</td>
                    </tr>
                </tbody>
            </table>

            <h3>Rate Controller Parameters</h3>
            <table>
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>MC_ROLLRATE_P, MC_ROLLRATE_I, MC_ROLLRATE_D</td>
                        <td>Roll rate PID gains</td>
                    </tr>
                    <tr>
                        <td>MC_ROLLRATE_FF, MC_ROLLRATE_K</td>
                        <td>Roll rate feedforward and global gain</td>
                    </tr>
                    <tr>
                        <td>MC_PITCHRATE_P, MC_PITCHRATE_I, MC_PITCHRATE_D</td>
                        <td>Pitch rate PID gains</td>
                    </tr>
                    <tr>
                        <td>MC_PITCHRATE_FF, MC_PITCHRATE_K</td>
                        <td>Pitch rate feedforward and global gain</td>
                    </tr>
                    <tr>
                        <td>MC_YAWRATE_P, MC_YAWRATE_I, MC_YAWRATE_D</td>
                        <td>Yaw rate PID gains</td>
                    </tr>
                    <tr>
                        <td>MC_YAWRATE_FF, MC_YAWRATE_K</td>
                        <td>Yaw rate feedforward and global gain</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section>
            <h2>Implementation Notes</h2>
            <ul>
                <li><strong>No singularities:</strong> Both goal and obstacles use \(\varepsilon\) to avoid \(1/r^2\)
                    blow-ups.</li>
                <li><strong>Dimensionless tanh:</strong> \(\dfrac{\lVert \vec{F}_{\text{obs, raw}}
                    \rVert}{F_{\text{sat}}}\) is unitless; \(F_{\text{fac,squash}}\) carries the resulting Newton scale.
                </li>
                <li><strong>Performance optimization:</strong> For \(\lvert \tanh(x) - x \rvert < 0.01\) when \(x \in
                        [-0.3, 0.3]\), we skip squashing to improve performance.</li>
                <li><strong>Velocity control:</strong> The system uses VFF guidance for direction and speed, followed by
                    a PX4-like cascaded control architecture for precise velocity and attitude tracking.</li>
                <li><strong>Slow-down behavior:</strong> The velocity magnitude scales linearly with distance to goal
                    (below \(d_{\text{slow}}\)), with a minimum of \(v_{\text{ideal}}/3\).</li>
            </ul>
        </section>

        <div class="navigation-buttons">
            <a href="quickstart.html" class="btn">← Quick Start</a>
            <a href="results.html" class="btn">Results →</a>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>Developed at Escola Politécnica da USP</p>
            <p>Department of Computer Engineering and Digital Systems</p>
        </div>
    </footer>

    <script src="scripts/main.js"></script>
</body>

</html>